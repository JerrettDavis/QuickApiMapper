@page "/create"
@page "/edit/{id:guid}"
@using QuickApiMapper.Designer.Web.Services
@using QuickApiMapper.Designer.Web.Components.Dialogs
@using QuickApiMapper.Management.Api.Models
@inject IntegrationApiClient ApiClient
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IDialogService DialogService

<PageTitle>@(IsEditMode ? "Edit Integration" : "Create Integration")</PageTitle>

<div class="fade-in">
    @* Header *@
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-6">
        <div>
            <MudText Typo="Typo.h3" Class="font-bold">@(IsEditMode ? "Edit Integration" : "Create Integration")</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Configure all integration settings in one view
            </MudText>
        </div>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Outlined" OnClick="Cancel">Cancel</MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       StartIcon="@Icons.Material.Filled.Save"
                       OnClick="SaveIntegration">
                @(IsEditMode ? "Update Integration" : "Create Integration")
            </MudButton>
        </MudStack>
    </MudStack>

    @* 1. Basic Information *@
    <MudPaper Elevation="2" Class="pa-6 mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
            <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Primary" Size="Size.Large" />
            <MudText Typo="Typo.h5" Class="font-semibold">Basic Information</MudText>
        </MudStack>

        <MudGrid>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="_model.Name"
                              Label="Integration Name"
                              Required="true"
                              Variant="Variant.Outlined"
                              HelperText="Unique name for this integration" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="_model.Endpoint"
                              Label="Endpoint Path"
                              Required="true"
                              Variant="Variant.Outlined"
                              HelperText="e.g., /api/integration1" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudSelect @bind-Value="_model.SourceType"
                           Label="Source Type"
                           Required="true"
                           Variant="Variant.Outlined">
                    <MudSelectItem Value="@("JSON")">JSON</MudSelectItem>
                    <MudSelectItem Value="@("XML")">XML</MudSelectItem>
                    <MudSelectItem Value="@("SOAP")">SOAP</MudSelectItem>
                    <MudSelectItem Value="@("gRPC")">gRPC</MudSelectItem>
                    <MudSelectItem Value="@("ServiceBus")">Azure Service Bus</MudSelectItem>
                    <MudSelectItem Value="@("RabbitMQ")">RabbitMQ</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudSelect @bind-Value="_model.DestinationType"
                           Label="Destination Type"
                           Required="true"
                           Variant="Variant.Outlined">
                    <MudSelectItem Value="@("JSON")">JSON</MudSelectItem>
                    <MudSelectItem Value="@("XML")">XML</MudSelectItem>
                    <MudSelectItem Value="@("SOAP")">SOAP</MudSelectItem>
                    <MudSelectItem Value="@("gRPC")">gRPC</MudSelectItem>
                    <MudSelectItem Value="@("ServiceBus")">Azure Service Bus</MudSelectItem>
                    <MudSelectItem Value="@("RabbitMQ")">RabbitMQ</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12">
                <MudTextField @bind-Value="_model.DestinationUrl"
                              Label="Destination URL"
                              Required="true"
                              Variant="Variant.Outlined"
                              HelperText="Target endpoint to send transformed data" />
            </MudItem>
            <MudItem xs="12">
                <MudSwitch @bind-Value="_model.IsActive"
                           Label="Active"
                           Color="Color.Success" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    @* 2. Protocol Configuration *@
    @if (_model.SourceType == "SOAP" || _model.DestinationType == "SOAP" ||
         _model.SourceType == "gRPC" || _model.DestinationType == "gRPC" ||
         _model.SourceType == "ServiceBus" || _model.DestinationType == "ServiceBus" ||
         _model.SourceType == "RabbitMQ" || _model.DestinationType == "RabbitMQ")
    {
        <MudPaper Elevation="2" Class="pa-6 mb-4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.Settings" Color="Color.Secondary" Size="Size.Large" />
                <MudText Typo="Typo.h5" Class="font-semibold">Protocol Configuration</MudText>
            </MudStack>

            <MudGrid>
                @if (_model.SourceType == "SOAP" || _model.DestinationType == "SOAP")
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">SOAP Configuration</MudText>
                        <MudTextField @bind-Value="_soapBodyWrapperXPath"
                                      Label="Body Wrapper XPath"
                                      Variant="Variant.Outlined"
                                      HelperText="XPath to SOAP body wrapper element" />
                    </MudItem>
                }

                @if (_model.SourceType == "gRPC" || _model.DestinationType == "gRPC")
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">gRPC Configuration</MudText>
                        <MudTextField @bind-Value="_grpcServiceName"
                                      Label="Service Name"
                                      Variant="Variant.Outlined"
                                      HelperText="gRPC service name" />
                        <MudTextField @bind-Value="_grpcMethodName"
                                      Label="Method Name"
                                      Variant="Variant.Outlined"
                                      HelperText="gRPC method name"
                                      Class="mt-2" />
                    </MudItem>
                }

                @if (_model.SourceType == "ServiceBus" || _model.DestinationType == "ServiceBus")
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">Azure Service Bus Configuration</MudText>
                        <MudTextField @bind-Value="_serviceBusConnectionString"
                                      Label="Connection String"
                                      Variant="Variant.Outlined"
                                      HelperText="Service Bus connection string"
                                      InputType="InputType.Password" />
                        <MudTextField @bind-Value="_serviceBusQueue"
                                      Label="Queue/Topic Name"
                                      Variant="Variant.Outlined"
                                      HelperText="Queue or topic name"
                                      Class="mt-2" />
                    </MudItem>
                }

                @if (_model.SourceType == "RabbitMQ" || _model.DestinationType == "RabbitMQ")
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">RabbitMQ Configuration</MudText>
                        <MudTextField @bind-Value="_rabbitMqHostName"
                                      Label="Host Name"
                                      Variant="Variant.Outlined"
                                      HelperText="RabbitMQ host" />
                        <MudTextField @bind-Value="_rabbitMqExchange"
                                      Label="Exchange"
                                      Variant="Variant.Outlined"
                                      HelperText="Exchange name"
                                      Class="mt-2" />
                        <MudTextField @bind-Value="_rabbitMqRoutingKey"
                                      Label="Routing Key"
                                      Variant="Variant.Outlined"
                                      HelperText="Routing key"
                                      Class="mt-2" />
                    </MudItem>
                }
            </MudGrid>
        </MudPaper>
    }

    @* 3. Field Mappings *@
    <MudPaper Elevation="2" Class="pa-6 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudStack Row="true" AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Filled.CompareArrows" Color="Color.Info" Size="Size.Large" />
                <MudText Typo="Typo.h5" Class="font-semibold">
                    Field Mappings
                    @if (_model.FieldMappings?.Any() == true)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="ml-2">@_model.FieldMappings.Count</MudChip>
                    }
                </MudText>
            </MudStack>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="AddFieldMapping"
                       Size="Size.Small">
                Add Mapping
            </MudButton>
        </MudStack>

        @if (_model.FieldMappings != null && _model.FieldMappings.Any())
        {
            <MudTable Items="_model.FieldMappings" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
                <HeaderContent>
                    <MudTh>Order</MudTh>
                    <MudTh>Source</MudTh>
                    <MudTh>Destination</MudTh>
                    <MudTh>Transformers</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Order</MudTd>
                    <MudTd>
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@context.Source</MudChip>
                    </MudTd>
                    <MudTd>
                        <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@context.Destination</MudChip>
                    </MudTd>
                    <MudTd>@(context.Transformers?.Count ?? 0)</MudTd>
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Size="Size.Small"
                                       OnClick="@(() => EditFieldMapping(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="@(() => DeleteFieldMapping(context))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudAlert Severity="Severity.Warning">
                No field mappings defined. Add at least one mapping to proceed.
            </MudAlert>
        }
    </MudPaper>

    @* 4. Static Values *@
    <MudPaper Elevation="2" Class="pa-6 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudStack Row="true" AlignItems="AlignItems.Center">
                <MudIcon Icon="@Icons.Material.Filled.Tune" Color="Color.Warning" Size="Size.Large" />
                <MudText Typo="Typo.h5" Class="font-semibold">
                    Static Values
                    @if (_model.StaticValues?.Any() == true)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="ml-2">@_model.StaticValues.Count</MudChip>
                    }
                </MudText>
            </MudStack>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Warning"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="AddStaticValue"
                       Size="Size.Small">
                Add Static Value
            </MudButton>
        </MudStack>

        @if (_model.StaticValues != null && _model.StaticValues.Any())
        {
            <MudSimpleTable Hover="true" Dense="true">
                <thead>
                    <tr>
                        <th>Key</th>
                        <th>Value</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var kvp in _model.StaticValues)
                    {
                        <tr>
                            <td><MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined">$$@kvp.Key</MudChip></td>
                            <td>@kvp.Value</td>
                            <td>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Color="Color.Error"
                                               Size="Size.Small"
                                               OnClick="@(() => DeleteStaticValue(kvp.Key))" />
                            </td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        }
        else
        {
            <MudAlert Severity="Severity.Info">
                No static values configured. Static values can be referenced in mappings using the $$key syntax.
            </MudAlert>
        }
    </MudPaper>

    @* 5. Schema Preview (Optional) *@
    @if (_model.FieldMappings?.Any() == true)
    {
        <MudPaper Elevation="2" Class="pa-6 mb-4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.Preview" Color="Color.Success" Size="Size.Large" />
                <MudText Typo="Typo.h5" Class="font-semibold">Schema Preview</MudText>
            </MudStack>

            <MudGrid>
                <MudItem xs="12" md="6">
                    <SchemaPreview SourceType="@_model.SourceType"
                                  FieldMappings="@_model.FieldMappings"
                                  StaticValues="@_model.StaticValues"
                                  Title="Source Schema"
                                  IsSource="true" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <SchemaPreview SourceType="@_model.DestinationType"
                                  FieldMappings="@_model.FieldMappings"
                                  StaticValues="@_model.StaticValues"
                                  Title="Destination Schema"
                                  IsSource="false" />
                </MudItem>
            </MudGrid>
        </MudPaper>
    }

    @* Bottom Action Bar *@
    <MudPaper Elevation="4" Class="pa-4 sticky-bottom">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @if (_model.FieldMappings?.Any() == true)
                {
                    <text>@_model.FieldMappings.Count field mapping(s) configured</text>
                }
                else
                {
                    <text>No field mappings configured yet</text>
                }
            </MudText>
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Outlined" OnClick="Cancel">Cancel</MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Success"
                           StartIcon="@Icons.Material.Filled.Save"
                           OnClick="SaveIntegration"
                           Size="Size.Large">
                    @(IsEditMode ? "Update Integration" : "Create Integration")
                </MudButton>
            </MudStack>
        </MudStack>
    </MudPaper>
</div>

@code {
    [Parameter]
    public Guid? Id { get; set; }

    private CreateIntegrationRequest _model = new();
    private bool IsEditMode => Id.HasValue && Id.Value != Guid.Empty;

    // Protocol-specific fields
    private string? _soapBodyWrapperXPath;
    private string? _grpcServiceName;
    private string? _grpcMethodName;
    private string? _serviceBusConnectionString;
    private string? _serviceBusQueue;
    private string? _rabbitMqHostName;
    private string? _rabbitMqExchange;
    private string? _rabbitMqRoutingKey;

    // Schema import (keeping for future use)
#pragma warning disable CS0169
    private string? _sourceSchemaUrl;
    private string? _destinationSchemaUrl;
    private SchemaTreeNode? _sourceSchemaTree;
    private SchemaTreeNode? _destinationSchemaTree;
#pragma warning restore CS0169

    protected override async Task OnInitializedAsync()
    {
        if (IsEditMode)
        {
            await LoadIntegration();
        }
        else
        {
            InitializeNewIntegration();
        }
    }

    private void InitializeNewIntegration()
    {
        _model = new CreateIntegrationRequest
        {
            IsActive = true,
            FieldMappings = new List<FieldMappingDto>(),
            StaticValues = new Dictionary<string, string>()
        };
    }

    private async Task LoadIntegration()
    {
        if (!Id.HasValue) return;

        var integration = await ApiClient.GetIntegrationByIdAsync(Id.Value);
        if (integration == null)
        {
            Snackbar.Add("Integration not found", Severity.Error);
            Navigation.NavigateTo("/integrations");
            return;
        }

        _model = new CreateIntegrationRequest
        {
            Name = integration.Name,
            Endpoint = integration.Endpoint,
            SourceType = integration.SourceType,
            DestinationType = integration.DestinationType,
            DestinationUrl = integration.DestinationUrl,
            IsActive = integration.IsActive,
            FieldMappings = integration.FieldMappings?.ToList() ?? new List<FieldMappingDto>(),
            StaticValues = integration.StaticValues ?? new Dictionary<string, string>(),
            SoapConfig = integration.SoapConfig
        };

        // Load protocol-specific config
        if (integration.SoapConfig != null)
        {
            _soapBodyWrapperXPath = integration.SoapConfig.BodyWrapperFieldXpath;
        }
    }

    private async Task SaveIntegration()
    {
        // Build SOAP config if needed
        if (!string.IsNullOrEmpty(_soapBodyWrapperXPath))
        {
            _model.SoapConfig = new SoapConfigDto
            {
                BodyWrapperFieldXpath = _soapBodyWrapperXPath
            };
        }

        try
        {
            if (IsEditMode)
            {
                var updateRequest = new UpdateIntegrationRequest
                {
                    Name = _model.Name,
                    Endpoint = _model.Endpoint,
                    SourceType = _model.SourceType,
                    DestinationType = _model.DestinationType,
                    DestinationUrl = _model.DestinationUrl,
                    IsActive = _model.IsActive,
                    FieldMappings = _model.FieldMappings,
                    StaticValues = _model.StaticValues,
                    SoapConfig = _model.SoapConfig
                };

                await ApiClient.UpdateIntegrationAsync(Id!.Value, updateRequest);
                Snackbar.Add("Integration updated successfully", Severity.Success);
            }
            else
            {
                await ApiClient.CreateIntegrationAsync(_model);
                Snackbar.Add("Integration created successfully", Severity.Success);
            }

            Navigation.NavigateTo("/integrations");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving integration: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/integrations");
    }

    private async Task AddFieldMapping()
    {
        var newMapping = new FieldMappingDto
        {
            Id = Guid.NewGuid(),
            Order = (_model.FieldMappings?.Max(m => m.Order) ?? 0) + 1,
            Source = "",
            Destination = "",
            Transformers = new List<TransformerDto>()
        };

        var parameters = new DialogParameters<EditFieldMappingDialog>
        {
            { x => x.Model, newMapping }
        };

        var dialog = await DialogService.ShowAsync<EditFieldMappingDialog>("Add Field Mapping", parameters);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is FieldMappingDto mapping)
        {
            _model.FieldMappings ??= new List<FieldMappingDto>();
            _model.FieldMappings.Add(mapping);
            Snackbar.Add("Field mapping added", Severity.Success);
        }
    }

    private async Task EditFieldMapping(FieldMappingDto mapping)
    {
        var parameters = new DialogParameters<EditFieldMappingDialog>
        {
            { x => x.Model, mapping }
        };

        var dialog = await DialogService.ShowAsync<EditFieldMappingDialog>("Edit Field Mapping", parameters);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is FieldMappingDto updatedMapping)
        {
            // Update the mapping in place
            var index = _model.FieldMappings!.IndexOf(mapping);
            if (index >= 0)
            {
                _model.FieldMappings[index] = updatedMapping;
            }
            Snackbar.Add("Field mapping updated", Severity.Success);
        }
    }

    private void DeleteFieldMapping(FieldMappingDto mapping)
    {
        _model.FieldMappings?.Remove(mapping);

        // Reorder remaining mappings
        if (_model.FieldMappings != null)
        {
            var orderedMappings = _model.FieldMappings.OrderBy(m => m.Order).ToList();
            for (int i = 0; i < orderedMappings.Count; i++)
            {
                orderedMappings[i].Order = i + 1;
            }
        }

        Snackbar.Add("Field mapping deleted", Severity.Success);
    }

    private async Task AddStaticValue()
    {
        var dialog = await DialogService.ShowAsync<AddStaticValueDialog>("Add Static Value");
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is KeyValuePair<string, string> kvp)
        {
            _model.StaticValues ??= new Dictionary<string, string>();

            if (_model.StaticValues.ContainsKey(kvp.Key))
            {
                Snackbar.Add($"Key '{kvp.Key}' already exists", Severity.Warning);
                return;
            }

            _model.StaticValues[kvp.Key] = kvp.Value;
            Snackbar.Add($"Static value '{kvp.Key}' added", Severity.Success);
        }
    }

    private void DeleteStaticValue(string key)
    {
        _model.StaticValues?.Remove(key);
        Snackbar.Add($"Static value '{key}' deleted", Severity.Success);
    }

    private async Task ImportSourceSchema()
    {
        var dialog = await DialogService.ShowAsync<SchemaImportDialog>("Import Source Schema");
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is List<string> fields)
        {
            // Auto-generate field mappings from imported schema
            var startOrder = (_model.FieldMappings?.Count ?? 0) + 1;

            _model.FieldMappings ??= new List<FieldMappingDto>();

            foreach (var field in fields)
            {
                _model.FieldMappings.Add(new FieldMappingDto
                {
                    Source = field,
                    Destination = string.Empty, // User needs to map this
                    Order = startOrder++,
                    Transformers = new List<TransformerDto>()
                });
            }

            Snackbar.Add($"Imported {fields.Count} fields from schema", Severity.Success);
        }
    }

    private async Task ImportDestinationSchema()
    {
        var dialog = await DialogService.ShowAsync<SchemaImportDialog>("Import Destination Schema");
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is List<string> fields)
        {
            Snackbar.Add($"Detected {fields.Count} destination fields. Use them when mapping.", Severity.Info);
        }
    }
}
