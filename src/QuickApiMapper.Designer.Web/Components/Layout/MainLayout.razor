@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<MudThemeProvider Theme="@_customTheme" IsDarkMode="@_isDarkMode" />

<MudLayout>
                    <MudAppBar Elevation="0" Class="border-b">
                        <MudIconButton Icon="@Icons.Material.Filled.Menu"
                                      Color="Color.Inherit"
                                      Edge="Edge.Start"
                                      OnClick="@ToggleDrawer" />
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Hub"
                                    Color="Color.Primary"
                                    Size="Size.Large" />
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.h6" Class="font-bold">QuickApiMapper</MudText>
                                <MudText Typo="Typo.caption" Class="text-secondary">Integration Designer</MudText>
                            </MudStack>
                        </MudStack>
                        <MudSpacer />

                        @* Theme Toggle *@
                        <MudTooltip Text="@GetThemeTooltip()">
                            <MudIconButton Icon="@GetThemeIcon()"
                                          Color="Color.Inherit"
                                          OnClick="@(async () => await ToggleTheme())" />
                        </MudTooltip>

                        @* Settings *@
                        <MudTooltip Text="Settings">
                            <MudIconButton Icon="@Icons.Material.Filled.Settings"
                                          Color="Color.Inherit"
                                          Href="/settings" />
                        </MudTooltip>
                    </MudAppBar>

                    <MudDrawer @bind-Open="_drawerOpen"
                              ClipMode="DrawerClipMode.Always"
                              Elevation="0"
                              Variant="DrawerVariant.Mini"
                              OpenMiniOnHover="true"
                              Class="border-r">
                        <MudDrawerHeader Class="border-b">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.Center">
                                <MudIcon Icon="@Icons.Material.Filled.Dashboard" Color="Color.Primary" />
                                <MudText Typo="Typo.h6" Class="font-semibold">Menu</MudText>
                            </MudStack>
                        </MudDrawerHeader>
                        <NavMenu />
                    </MudDrawer>

                    <MudMainContent Style="background: var(--mud-palette-background); padding-top: 80px;">
                        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="px-6 py-6">
                            @Body
                        </MudContainer>
                    </MudMainContent>
                </MudLayout>

@code {
    private bool _drawerOpen = true;
    private ThemeMode _themeMode = ThemeMode.System;
    private bool _isDarkMode = false;
    private DotNetObjectReference<MainLayout>? _dotNetHelper;

    private readonly MudTheme _customTheme = new()
    {
        PaletteLight = new PaletteLight
        {
            Primary = "#6366F1",
            Secondary = "#EC4899",
            Success = "#10B981",
            Info = "#3B82F6",
            Warning = "#F59E0B",
            Error = "#EF4444",
            Dark = "#1E293B",
            TextPrimary = "#0F172A",
            TextSecondary = "#475569",
            Background = "#F8FAFC",
            Surface = "#FFFFFF"
        },
        PaletteDark = new PaletteDark
        {
            Primary = "#818CF8",
            Secondary = "#F472B6",
            Success = "#34D399",
            Info = "#60A5FA",
            Warning = "#FBBF24",
            Error = "#F87171",
            Dark = "#0F172A",
            TextPrimary = "#F1F5F9",
            TextSecondary = "#94A3B8",
            Background = "#0F172A",
            Surface = "#1E293B"
        }
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetHelper = DotNetObjectReference.Create(this);

            // Get initial system theme preference
            await UpdateDarkModeFromSystemAsync();

            // Listen for system theme changes
            await JSRuntime.InvokeVoidAsync("themeDetector.addSystemThemeListener", _dotNetHelper);

            StateHasChanged();
        }
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task ToggleTheme()
    {
        _themeMode = _themeMode switch
        {
            ThemeMode.System => ThemeMode.Light,
            ThemeMode.Light => ThemeMode.Dark,
            ThemeMode.Dark => ThemeMode.System,
            _ => ThemeMode.System
        };

        await UpdateDarkModeFromTheme();
    }

    private async Task UpdateDarkModeFromTheme()
    {
        if (_themeMode == ThemeMode.System)
        {
            await UpdateDarkModeFromSystemAsync();
        }
        else
        {
            _isDarkMode = _themeMode == ThemeMode.Dark;
        }
        StateHasChanged();
    }

    private async Task UpdateDarkModeFromSystemAsync()
    {
        try
        {
            _isDarkMode = await JSRuntime.InvokeAsync<bool>("themeDetector.isDarkMode");
        }
        catch
        {
            // Fallback to light mode if JS interop fails
            _isDarkMode = false;
        }
    }

    [JSInvokable]
    public async Task OnSystemThemeChanged(bool isDark)
    {
        // Only update if we're in System mode
        if (_themeMode == ThemeMode.System)
        {
            _isDarkMode = isDark;
            await InvokeAsync(StateHasChanged);
        }
    }

    private string GetThemeIcon()
    {
        return _themeMode switch
        {
            ThemeMode.System => Icons.Material.Filled.BrightnessAuto,
            ThemeMode.Light => Icons.Material.Filled.LightMode,
            ThemeMode.Dark => Icons.Material.Filled.DarkMode,
            _ => Icons.Material.Filled.BrightnessAuto
        };
    }

    private string GetThemeTooltip()
    {
        return _themeMode switch
        {
            ThemeMode.System => "Theme: System (click for Light)",
            ThemeMode.Light => "Theme: Light (click for Dark)",
            ThemeMode.Dark => "Theme: Dark (click for System)",
            _ => "Theme: System"
        };
    }

    private enum ThemeMode
    {
        System,
        Light,
        Dark
    }

    public async ValueTask DisposeAsync()
    {
        if (_dotNetHelper != null)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("themeDetector.removeSystemThemeListener");
            }
            catch
            {
                // Ignore errors during disposal
            }
            _dotNetHelper.Dispose();
        }
    }
}
